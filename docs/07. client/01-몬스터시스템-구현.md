---
문서명: 몬스터 시스템 구현 명세서
버전: 1.0
담당 에이전트: client-programmer
최종 수정: 2025-12-28
상태: 확정
---

# 몬스터 시스템 구현 명세서

## 개요

1챕터 몬스터 3종을 프로토타입 게임에 추가했습니다. 데이터 주도 설계를 기반으로 몬스터 타입, 패턴, AI 로직을 모듈화하여 구현했습니다.

## 구현 파일

### 1. 타입 정의 (`src/types/index.ts`)

```typescript
// 몬스터 타입
export type EnemyType = 'wandering_dead' | 'fallen_swordsman' | 'lich_knight';
export type EnemyDifficulty = 'weak' | 'medium' | 'strong' | 'elite';

// 패턴 타입
export type PatternType =
  | 'prepare_attack'      // 준비 후 공격
  | 'apply_debuff'        // 디버프 적용
  | 'parry'               // 패링 (반격)
  | 'multi_attack'        // 연속 공격
  | 'shield'              // 보호막 생성
  | 'execute'             // 처형 일격
  | 'revive';             // 부활

// 디버프 타입
export type DebuffType = 'sorrow' | 'bleed' | 'weak' | 'vulnerable';
```

#### 핵심 인터페이스

**EnemyPattern**: 몬스터 행동 패턴
- `type`: 패턴 타입
- `name`: 패턴 이름
- `description`: 패턴 설명
- `damage?`: 기본 피해량
- `damageMultiplier?`: 피해 배율
- `debuff?`: 부여할 디버프
- `shield?`: 보호막 수치
- `attackCount?`: 연속 공격 횟수
- `turnCooldown?`: 패턴 쿨다운
- `condition?`: 발동 조건

**EnemyState**: 몬스터 전투 상태
- `currentPattern`: 현재 사용 중인 패턴
- `patternCooldowns`: 패턴별 쿨다운 카운터
- `isParrying`: 패링 상태
- `shield`: 현재 보호막
- `hasRevived`: 부활 사용 여부
- `preparingAttack`: 공격 준비 중

**Enemy**: 확장된 몬스터 인터페이스
- 기본 정보: `id`, `type`, `name`, `difficulty`, `description`, `quote`
- 전투 스탯: `maxHp`, `currentHp`, `baseAttackDamage`
- 패턴 및 상태: `patterns`, `state`
- 보상: `rewards` (골드, 영혼, 카드/유물 드롭률)
- 레거시 호환: `attackDamage`, `isStunned`

**Debuff**: 디버프 정보
- `type`: 디버프 타입
- `name`: 디버프 이름
- `description`: 디버프 설명
- `damage?`: 턴당 피해
- `duration`: 남은 턴 수
- `effect?`: 기타 효과

### 2. 몬스터 데이터 (`src/data/enemies.ts`)

#### 1. 방황하는 망자 (약)

```typescript
export const WANDERING_DEAD: Enemy = {
  id: 'wandering_dead_01',
  type: 'wandering_dead',
  name: '방황하는 망자',
  difficulty: 'weak',
  quote: '여기가... 어디지? 나는... 살아있나?',

  maxHp: 35,
  currentHp: 35,
  baseAttackDamage: 5,

  patterns: [
    {
      type: 'prepare_attack',
      name: '공격 준비',
      description: '다음 턴에 약한 공격을 가한다.',
      damage: 5,
      turnCooldown: 2
    },
    {
      type: 'apply_debuff',
      name: '슬픔의 기운',
      description: '플레이어에게 슬픔 디버프를 부여한다.',
      debuff: 'sorrow',
      turnCooldown: 3
    }
  ],

  rewards: {
    gold: { min: 3, max: 5 },
    souls: 1
  }
};
```

**특징**:
- 튜토리얼급 난이도
- 예측 가능한 패턴 (공격 전 1턴 준비)
- 슬픔 디버프로 지속 피해 학습

#### 2. 타락한 검사 (중)

```typescript
export const FALLEN_SWORDSMAN: Enemy = {
  id: 'fallen_swordsman_01',
  type: 'fallen_swordsman',
  name: '타락한 검사',
  difficulty: 'medium',
  quote: '검의 길... 끝에는 오직 죽음만이.',

  maxHp: 65,
  currentHp: 65,
  baseAttackDamage: 10,

  patterns: [
    {
      type: 'parry',
      name: '패링 자세',
      description: '방어 태세. 공격을 받으면 2배 데미지로 반격한다.',
      damageMultiplier: 2,
      turnCooldown: 2
    },
    {
      type: 'multi_attack',
      name: '연속 베기',
      description: '2~3회 약한 연타를 가한다.',
      damage: 4,
      attackCount: 3,
      turnCooldown: 3
    }
  ],

  rewards: {
    gold: { min: 8, max: 12 },
    souls: 2,
    cardDropRate: 0.1
  }
};
```

**특징**:
- 중간 난이도
- 패링 메커니즘 (타이밍 판단 필요)
- 연속 공격으로 압박

#### 3. 리치의 기사 (강/엘리트)

```typescript
export const LICH_KNIGHT: Enemy = {
  id: 'lich_knight_01',
  type: 'lich_knight',
  name: '리치의 기사',
  difficulty: 'elite',
  quote: '주인님의 뜻이라면, 나는 영원히 싸우리라.',

  maxHp: 110,
  currentHp: 110,
  baseAttackDamage: 15,

  patterns: [
    {
      type: 'shield',
      name: '리치의 가호',
      description: '강력한 보호막을 생성한다.',
      shield: 30,
      turnCooldown: 3
    },
    {
      type: 'execute',
      name: '처형 일격',
      description: 'HP 50% 이하일 때 강력한 단타를 가한다.',
      damageMultiplier: 2,
      condition: 'HP 50% 이하'
    },
    {
      type: 'revive',
      name: '부활 명령',
      description: '처치 시 50% 확률로 HP 30%로 부활한다.',
      condition: '처치 시'
    }
  ],

  rewards: {
    gold: { min: 20, max: 30 },
    souls: 5,
    cardDropRate: 0.3,
    relicDropRate: 0.05
  }
};
```

**특징**:
- 높은 난이도 (엘리트)
- 복합 전략 요구 (보호막, 조건부 강화, 부활)
- 높은 보상 (유물 드롭 가능)

#### 헬퍼 함수

```typescript
// 난이도별 몬스터 가져오기
getEnemiesByDifficulty(difficulty: EnemyDifficulty): Enemy[]

// 랜덤 몬스터 가져오기 (깊은 복사)
getRandomEnemy(): Enemy

// ID로 몬스터 가져오기
getEnemyById(id: string): Enemy | undefined
```

### 3. 패턴 시스템 (`src/utils/enemyAI.ts`)

#### 패턴 결정 로직

```typescript
decideNextPattern(enemy: Enemy): EnemyPattern | null
```

**알고리즘**:
1. 쿨다운 체크 (쿨다운 중인 패턴 제외)
2. 조건 체크 (HP 50% 이하 등)
3. 우선순위 선택:
   - 조건부 패턴 (execute 등) 우선
   - 그 외 랜덤 선택

#### 패턴 실행 로직

```typescript
executePattern(
  enemy: Enemy,
  player: Player,
  pattern: EnemyPattern
): {
  updatedEnemy: Enemy;
  updatedPlayer: Player;
  message: string;
  damageDealt: number;
}
```

**패턴별 처리**:

1. **prepare_attack**: 공격 준비 상태로 전환
2. **apply_debuff**: 플레이어에게 디버프 부여
3. **parry**: 패링 상태로 전환 (다음 공격 시 반격)
4. **multi_attack**: 연속 공격 실행
5. **shield**: 보호막 생성
6. **execute**: 조건부 강화 공격
7. **revive**: 부활 (별도 함수 처리)

#### 주요 헬퍼 함수

```typescript
// 디버프 효과 적용 (턴 시작 시)
applyDebuffs(player: Player): {
  updatedPlayer: Player;
  damageDealt: number;
  messages: string[];
}

// 준비된 공격 실행
executePreparedAttack(enemy: Enemy, player: Player): {
  updatedEnemy: Enemy;
  updatedPlayer: Player;
  damageDealt: number;
}

// 패링 반격 처리
handleParryCounter(
  enemy: Enemy,
  player: Player,
  playerAttackDamage: number
): {
  updatedEnemy: Enemy;
  updatedPlayer: Player;
  counterDamage: number;
}

// 부활 체크
checkRevive(enemy: Enemy): {
  shouldRevive: boolean;
  revivedEnemy?: Enemy;
}

// 쿨다운 감소 (턴 종료 시)
decreaseCooldowns(enemy: Enemy): Enemy

// 보호막에 피해 적용
applyDamageToShield(enemy: Enemy, damage: number): {
  updatedEnemy: Enemy;
  remainingDamage: number;
  shieldBlocked: number;
}
```

### 4. 게임 스토어 수정 (`src/stores/gameStore.ts`)

#### 변경 사항

**1. startGame 함수 수정**
```typescript
startGame: (enemyId?: string) => void
```
- 선택적 `enemyId` 파라미터 추가
- ID 지정 시 해당 몬스터 로드
- 미지정 시 랜덤 몬스터 로드

**2. performAttack 함수 확장**
```typescript
// 공격 순서:
1. 패링 체크 (handleParryCounter)
2. 보호막 처리 (applyDamageToShield)
3. 남은 피해 적용
4. 처치 시 부활 체크 (checkRevive)
```

**3. executeEnemyTurn 함수 추가**
```typescript
executeEnemyTurn: () => void
```

**적 턴 실행 순서**:
1. 디버프 적용 (`applyDebuffs`)
2. 준비된 공격 실행 (`executePreparedAttack`)
3. 다음 패턴 결정 및 실행 (`decideNextPattern` → `executePattern`)
4. 쿨다운 감소 (`decreaseCooldowns`)
5. 패배 체크

**4. endTurn 함수 수정**
```typescript
endTurn: () => void
```
- 기존 반격 로직 제거
- `executeEnemyTurn()` 호출로 대체
- 턴 상태 초기화

**5. resetGame 함수 수정**
```typescript
resetGame: () => void
```
- 새로운 랜덤 몬스터 생성 (`getRandomEnemy()`)

## 아키텍처 패턴

### 데이터 주도 설계 (Data-Driven Design)

```
데이터 파일 (enemies.ts)
    ↓
타입 시스템 (types/index.ts)
    ↓
AI 로직 (enemyAI.ts)
    ↓
게임 스토어 (gameStore.ts)
```

**장점**:
- 몬스터 추가/수정 시 데이터만 변경
- 기획자가 JSON으로 변환하여 직접 수정 가능
- 패턴 재사용 및 조합 용이
- 테스트 및 밸런싱 간편

### 패턴 시스템 (Strategy Pattern)

```typescript
interface EnemyPattern {
  type: PatternType;
  // ... 패턴별 파라미터
}

// 실행 시 type에 따라 분기
switch (pattern.type) {
  case 'prepare_attack': ...
  case 'parry': ...
  case 'shield': ...
}
```

**확장성**:
- 새로운 패턴 타입 추가 용이
- 패턴 조합으로 복잡한 행동 구현
- 조건부 패턴 지원 (HP 트리거 등)

### 상태 관리 (State Machine)

```typescript
interface EnemyState {
  currentPattern: PatternType | null;
  patternCooldowns: Record<string, number>;
  isParrying: boolean;
  shield: number;
  hasRevived: boolean;
  preparingAttack: boolean;
}
```

**상태 전이**:
- 패턴 실행 → 상태 업데이트
- 쿨다운 관리 → 패턴 선택 제약
- 플래그 기반 조건 체크

## 성능 고려사항

### 깊은 복사 (Deep Copy)

```typescript
export function getRandomEnemy(): Enemy {
  const randomIndex = Math.floor(Math.random() * CHAPTER1_ENEMIES.length);
  return JSON.parse(JSON.stringify(CHAPTER1_ENEMIES[randomIndex]));
}
```

**이유**:
- 각 전투마다 독립적인 몬스터 인스턴스 생성
- 원본 데이터 보호
- 상태 오염 방지

**주의**:
- `JSON.parse(JSON.stringify())`는 함수/순환 참조 복사 불가
- 현재 데이터는 순수 객체이므로 문제 없음
- 추가 복잡도 발생 시 lodash `cloneDeep` 고려

### 불필요한 할당 최소화

```typescript
// ❌ 매번 새 객체 생성
enemy.state.shield += 10;

// ✅ 필요 시에만 업데이트
const updatedEnemy = {
  ...enemy,
  state: {
    ...enemy.state,
    shield: enemy.state.shield + 10
  }
};
```

## 테스트 시나리오

### 1. 방황하는 망자
- [ ] 1턴: 공격 준비 → 준비 상태 확인
- [ ] 2턴: 준비된 공격 실행 → 5 피해 확인
- [ ] 슬픔 디버프 적용 → 2턴간 턴당 2 피해 확인
- [ ] 쿨다운 동작 확인

### 2. 타락한 검사
- [ ] 패링 상태일 때 공격 → 반격 20 피해 (10 * 2) 확인
- [ ] 패링 상태일 때 미공격 → 다음 턴 패링 해제 확인
- [ ] 연속 베기 → 3회 공격 (총 12 피해) 확인

### 3. 리치의 기사
- [ ] 보호막 생성 → 30 보호막 확인
- [ ] 보호막 있을 때 공격 → 보호막 먼저 차감 확인
- [ ] HP 50% 이하 → 처형 일격 (30 피해) 확인
- [ ] 처치 시 부활 → 50% 확률, HP 33 (30%) 확인
- [ ] 2회 부활 불가 확인

## 향후 개선 사항

### 1. UI 표시
```typescript
// 현재: console.log
// 개선: UI 컴포넌트에 메시지 표시
interface BattleLog {
  turn: number;
  message: string;
  type: 'player' | 'enemy' | 'system';
}
```

### 2. 애니메이션 연동
```typescript
// 패턴 실행 시 애니메이션 트리거
executePattern() {
  // ... 로직
  return {
    ...result,
    animation: pattern.type // UI에서 애니메이션 재생
  };
}
```

### 3. 난이도 조정
```typescript
// 데이터 파일에서 수치만 조정
const WANDERING_DEAD: Enemy = {
  maxHp: 35, // 30~40 사이 밸런싱
  baseAttackDamage: 5, // 4~6 사이 밸런싱
  // ...
};
```

### 4. 패턴 AI 고도화
```typescript
// 현재: 조건부 + 랜덤
// 개선: 우선순위 점수 시스템
interface PatternScore {
  pattern: EnemyPattern;
  score: number; // 현재 상황 기반 점수
}

function calculatePatternScore(
  enemy: Enemy,
  player: Player,
  pattern: EnemyPattern
): number {
  let score = 0;

  // HP 낮으면 방어 패턴 우선
  if (enemy.currentHp < enemy.maxHp * 0.3 && pattern.type === 'shield') {
    score += 50;
  }

  // 플레이어 HP 낮으면 공격 패턴 우선
  if (player.currentHp < player.maxHp * 0.3 && pattern.damage) {
    score += 30;
  }

  return score;
}
```

## 참조 문서

- `docs/05. 시나리오/04-1챕터-몬스터설계.md`: 몬스터 기획 문서
- `Prototype/src/types/index.ts`: 타입 정의
- `Prototype/src/data/enemies.ts`: 몬스터 데이터
- `Prototype/src/utils/enemyAI.ts`: AI 로직
- `Prototype/src/stores/gameStore.ts`: 게임 스토어

## 결론

1챕터 몬스터 3종을 성공적으로 프로토타입에 추가했습니다. 데이터 주도 설계와 모듈화된 구조를 통해 확장성과 유지보수성을 확보했으며, 각 몬스터는 고유한 패턴과 난이도를 가지고 있어 플레이어에게 다양한 전투 경험을 제공합니다.

모든 코드는 TypeScript 타입 체크를 통과했으며, 레거시 코드와의 호환성도 유지되었습니다.
